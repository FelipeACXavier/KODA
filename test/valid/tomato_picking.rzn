async task Drive(float x, float y) {
  trigger: void to_position(float x, float y);
  abort: void abort();
  return: void in_position(float x, float y);
  error: void path_blocked();
}

sync task ImageRecognition() {
  accepts {
    void recognize();
    void abort();
  }
  emits {
    void found();
  }
}

async task Picker() {
  trigger: void pick();
  abort: void abort();
  return: void picked();
  error: void failed();
}

sync task Siren() {
  accepts {
    void start():
      service: "/siren_start" "std_msgs::SirenControl";
    void stop():
      service: "/siren_stop" "std_msgs::SirenControl";
  }
}

task component TomatoPicking (drive req Drive, siren req Siren, 
                              image req ImageRecognition, picker req Picker,
                              float x1, float y1, float x2, float y2) 
{
  trigger: void start(float x1, float y1, float x2, float y2);
  return: void done();
  abort: void abort();
  error: void failed();

  vars {
    float x1_ = x1 : 0.0
    float y1_ = y1 : 0.0
    float x2_ = x2 : 0.0
    float y2_ = y2 : 0.0
  }

  strategy {
    err: siren.start() --> image.abort() --> end;
    abrt: image.abort() --> picker.abort() --> end;

    pick_tomato: picker() on error err;

    picking: repeat(
        (drive(x1_, y1_) on error err on abort abrt on image.found(x) if x < 3 do pick_tomato else end)
        -->
        (drive(x2_, y2_) on error err on abort abrt on image.found(x) pick_tomato)
    );

    main: siren.stop() --> image.recognize() --> picking;
  }
}
