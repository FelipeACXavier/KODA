capability Bridge(string zone) {
  service "poll" ""{
    in: void poll(string scene);
  }
}

capability Co2Sensor() {    
  service "co2/normal" ""{
    out: void normal();
  }
  service "co2/high" ""{
    out: void high();
  }
}

capability EnvSensor() {
  service "environment/empty" "" {
    out: void empty();
  }
  service "environment/present" "" {
    out: void present();
  }
}

capability Light(string scene) {
  service "lighting/scene" "" {
    in: void set(string scene);
  }
}

capability Ventilation(string up) {
    action "ventilation" "" {
      trigger: void solve(string up);
      return: void done();
      abort: void stop();
      error: void failed();
    }
}

task AirQuality (bridge req Bridge, co2sensor req Co2Sensor, envsensor req EnvSensor, 
                 light req Light, ventilation req Ventilation, string zone)
{
  trigger: void start(string zone);
  return:  void done();
  abort:   void abort();
  error:   void failed();

  vars {
    string zone_ = zone : "zone1"
    int count_ = 0 : 0
  }

  strategy {
    err:  ventilation.abort() --> light.set("Alert") --> end;
    abrt: ventilation.abort() --> end;

    ventilation [mode]: within 300 do ( ventilation(mode)
          on error err
          on abort abrt
          on envsensor.present() ( light.set("On") --> continue )
          on envsensor.empty() ( light.set("Off") --> continue )
        ) else err;

    main: every 10 { bridge.poll(zone_) }
      on abort ( abrt )
      on envsensor.present() ( light.set("On") )
      on envsensor.empty() ( light.set("Off") )
      on co2sensor.high() ( ventilation("down") )
      on co2sensor.normal() ( ventilation("up") );
  }
}
